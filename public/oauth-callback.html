<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OneDrive Authorization</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      width: 100%;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.1);
      text-align: center;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #f1f5f9;
    }

    .status {
      margin: 20px 0;
      padding: 16px;
      border-radius: 8px;
      font-size: 16px;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #86efac;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fecaca;
    }

    .status.processing {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }

    .spinner {
      margin: 20px auto;
      width: 48px;
      height: 48px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .code-display {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      word-break: break-all;
      color: #cbd5e1;
    }

    .instructions {
      color: #94a3b8;
      font-size: 14px;
      line-height: 1.6;
      margin-top: 20px;
    }

    button {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      padding: 12px 28px;
      font-size: 16px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }

    .close-hint {
      color: #64748b;
      font-size: 14px;
      margin-top: 20px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê OneDrive Authorization</h1>
    <div id="status" class="status processing">
      <div class="spinner"></div>
      <p>Processing authorization...</p>
    </div>
    <div id="code-container" style="display: none;">
      <p>Authorization code received:</p>
      <div id="code-display" class="code-display"></div>
      <p class="instructions">
        If this window doesn't close automatically, you can close it manually and return to the main application.
      </p>
      <button onclick="window.close()">Close Window</button>
    </div>
  </div>

  <script>
    (function() {
      const statusDiv = document.getElementById('status');
      const codeContainer = document.getElementById('code-container');
      const codeDisplay = document.getElementById('code-display');

      try {
        // Parse the URL parameters
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const error = params.get('error');
        const errorDescription = params.get('error_description');

        if (error) {
          // Authorization failed
          statusDiv.className = 'status error';
          statusDiv.innerHTML = `
            <p><strong>‚ùå Authorization Failed</strong></p>
            <p>${errorDescription || error}</p>
            <p class="close-hint">You can close this window and try again.</p>
          `;

          // Send error to parent window
          if (window.opener) {
            window.opener.postMessage({
              type: 'ONEDRIVE_AUTH_CODE',
              error: errorDescription || error
            }, window.location.origin);
          }
        } else if (code) {
          // Authorization successful
          statusDiv.className = 'status success';
          statusDiv.innerHTML = `
            <p><strong>‚úÖ Authorization Successful!</strong></p>
            <p>Sending authorization code to the application...</p>
          `;

          codeDisplay.textContent = code;
          codeContainer.style.display = 'block';

          // Send the code to the parent window
          if (window.opener) {
            window.opener.postMessage({
              type: 'ONEDRIVE_AUTH_CODE',
              code: code
            }, window.location.origin);

            // Auto-close after a short delay
            setTimeout(() => {
              statusDiv.innerHTML = `
                <p><strong>‚úÖ Complete!</strong></p>
                <p>This window will close automatically...</p>
              `;
              setTimeout(() => {
                window.close();
              }, 1000);
            }, 2000);
          } else {
            // No opener window, show manual instructions
            statusDiv.innerHTML = `
              <p><strong>‚úÖ Authorization Complete!</strong></p>
              <p class="instructions">Please copy the code below and paste it into the application.</p>
            `;
          }
        } else {
          // No code or error found
          statusDiv.className = 'status error';
          statusDiv.innerHTML = `
            <p><strong>‚ö†Ô∏è No Authorization Code Found</strong></p>
            <p class="instructions">The authorization callback did not include a code. Please try again.</p>
          `;
        }
      } catch (err) {
        console.error('Error processing OAuth callback:', err);
        statusDiv.className = 'status error';
        statusDiv.innerHTML = `
          <p><strong>‚ùå Error Processing Authorization</strong></p>
          <p>${err.message}</p>
          <p class="close-hint">You can close this window and try again.</p>
        `;
      }
    })();
  </script>
</body>
</html>
